<style>
    @font-face {
        font-family: 'a-jameel-noori-nastaleeq';
        src: url('/a-jameel-noori-nastaleeq.ttf');
        src: url('/a-jameel-noori-nastaleeq.ttf') format('truetype');
    }

    body {
        font-family: 'a-jameel-noori-nastaleeq', sans-serif;
    }

    #c {
        border: 1px solid red;
        top: 22px;
        left: 0px;
        height: 50%;
        width: 99%;
    }

    #htmlCanvas {
        border: 1px solid red;
        /* top: 22px;
        left: 0px;
        height: 50%;
        width: 99%; */
    }

    .box {
        float: left;
        margin: 1em;
    }

    .after-box {
        clear: left;
    }
</style>
<script src="/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
<!-- <script src="/dist/fabric.js"></script> -->
<!-- <script src="/script.js"></script> -->
<script src="/HEADER.js"></script>
<script src="/src/globalFabric.js"></script>
<script src="/lib/event.js"></script>
<script src="/src/mixins/observable.mixin.js"></script>
<script src="/src/mixins/collection.mixin.js"></script>
<script src="/src/mixins/shared_methods.mixin.js"></script>
<script src="/src/util/misc.js"></script>
<script src="/src/util/named_accessors.mixin.js"></script>
<script src="/src/util/arc.js"></script>
<script src="/src/util/lang_array.js"></script>
<script src="/src/util/lang_object.js"></script>
<script src="/src/util/lang_string.js"></script>
<script src="/src/util/lang_class.js"></script>
<script src="/src/util/dom_event.js"></script>
<script src="/src/util/dom_style.js"></script>
<script src="/src/util/dom_misc.js"></script>
<script src="/src/util/dom_request.js"></script>
<script src="/src/log.js"></script>
<script src="/src/util/animate.js"></script>
<script src="/src/util/animate_color.js"></script>
<script src="/src/util/anim_ease.js"></script>
<script src="/src/parser.js"></script>
<script src="/src/elements_parser.js"></script>
<script src="/src/point.class.js"></script>
<script src="/src/intersection.class.js"></script>
<script src="/src/color.class.js"></script>
<script src="/src/gradient.class.js"></script>
<script src="/src/pattern.class.js"></script>
<script src="/src/shadow.class.js"></script>
<script src="/src/static_canvas.class.js"></script>
<script src="/src/brushes/base_brush.class.js"></script>
<script src="/src/brushes/pencil_brush.class.js"></script>
<script src="/src/brushes/circle_brush.class.js"></script>
<script src="/src/brushes/spray_brush.class.js"></script>
<script src="/src/brushes/pattern_brush.class.js"></script>
<script src="/src/brushes/custom_brushes.class.js"></script>
<script src="/src/canvas.class.js"></script>
<script src="/src/mixins/canvas_events.mixin.js"></script>
<script src="/src/mixins/canvas_grouping.mixin.js"></script>
<script src="/src/mixins/canvas_dataurl_exporter.mixin.js"></script>
<script src="/src/mixins/canvas_serialization.mixin.js"></script>
<script src="/src/mixins/canvas_gestures.mixin.js"></script>
<script src="/src/shapes/object.class.js"></script>
<script src="/src/mixins/object_origin.mixin.js"></script>
<script src="/src/mixins/object_geometry.mixin.js"></script>
<script src="/src/mixins/object_stacking.mixin.js"></script>
<script src="/src/mixins/object.svg_export.js"></script>
<script src="/src/mixins/stateful.mixin.js"></script>
<script src="/src/mixins/object_interactivity.mixin.js"></script>
<script src="/src/mixins/animation.mixin.js"></script>
<script src="/src/mixins/customiseControls.js"></script>
<script src="/src/shapes/line.class.js"></script>
<script src="/src/shapes/circle.class.js"></script>
<script src="/src/shapes/triangle.class.js"></script>
<script src="/src/shapes/ellipse.class.js"></script>
<script src="/src/shapes/rect.class.js"></script>
<script src="/src/shapes/polyline.class.js"></script>
<script src="/src/shapes/polygon.class.js"></script>
<script src="/src/shapes/path.class.js"></script>
<script src="/src/shapes/group.class.js"></script>
<script src="/src/shapes/active_selection.class.js"></script>
<script src="/src/shapes/image.class.js"></script>
<script src="/src/mixins/object_straightening.mixin.js"></script>
<script src="/src/filters/webgl_backend.class.js"></script>
<script src="/src/filters/2d_backend.class.js"></script>
<script src="/src/filters/base_filter.class.js"></script>
<script src="/src/filters/colormatrix_filter.class.js"></script>
<script src="/src/filters/brightness_filter.class.js"></script>
<script src="/src/filters/convolute_filter.class.js"></script>
<script src="/src/filters/grayscale_filter.class.js"></script>
<script src="/src/filters/invert_filter.class.js"></script>
<script src="/src/filters/noise_filter.class.js"></script>
<script src="/src/filters/pixelate_filter.class.js"></script>
<script src="/src/filters/removecolor_filter.class.js"></script>
<script src="/src/filters/filter_generator.js"></script>
<script src="/src/filters/blendcolor_filter.class.js"></script>
<script src="/src/filters/blendimage_filter.class.js"></script>
<script src="/src/filters/resize_filter.class.js"></script>
<script src="/src/filters/contrast_filter.class.js"></script>
<script src="/src/filters/saturate_filter.class.js"></script>
<script src="/src/filters/blur_filter.class.js"></script>
<script src="/src/filters/gamma_filter.class.js"></script>
<script src="/src/filters/composed_filter.class.js"></script>
<script src="/src/filters/hue_rotation.class.js"></script>
<!-- <script src="/src/filters/glow.class.js"></script> -->
<script src="/src/filters/inner_shadow.class.js"></script>
<script src="/src/filters/outline.class.js"></script>
<script src="/src/filters/feather.class.js"></script>
<script src="/src/shapes/text.class.js"></script>
<script src="/src/mixins/text_style.mixin.js"></script>
<script src="/src/shapes/itext.class.js"></script>
<script src="/src/mixins/itext_behavior.mixin.js"></script>
<script src="/src/mixins/itext_click_behavior.mixin.js"></script>
<script src="/src/mixins/itext_key_behavior.mixin.js"></script>
<script src="/src/mixins/itext.svg_export.js"></script>
<script src="/src/shapes/textbox.class.js"></script>


<div class="box">

    <canvas id="c"></canvas>
    <canvas id="htmlCanvas"></canvas>
</div>


<div id="text-wrapper" style="margin-top: 10px" ng-show="getText()">

    <div id="text-controls">
        <input type="color" value="" id="text-color" size="10">
        <label for="font-family" style="display:inline-block">Font family:</label>
        <select id="font-family">
            <option value="arial">Arial</option>
            <option value="helvetica" selected>Helvetica</option>
            <option value="myriad pro">Myriad Pro</option>
            <option value="delicious">Delicious</option>
            <option value="verdana">Verdana</option>
            <option value="georgia">Georgia</option>
            <option value="courier">Courier</option>
            <option value="comic sans ms">Comic Sans MS</option>
            <option value="impact">Impact</option>
            <option value="monaco">Monaco</option>
            <option value="optima">Optima</option>
            <option value="hoefler text">Hoefler Text</option>
            <option value="plaster">Plaster</option>
            <option value="engagement">Engagement</option>
        </select>
        <br>
        <label for="text-align" style="display:inline-block">Text align:</label>
        <select id="text-align">
            <option value="left">Left</option>
            <option value="center">Center</option>
            <option value="right">Right</option>
            <option value="justify">Justify</option>
            <option value="justify-center">justify-center</option>
            <option value="justify-left">justify-left</option>
            <option value="justify-right">justify-right</option>
        </select>
        <div>
            <label for="text-bg-color">Background color:</label>
            <input type="color" value="" id="text-bg-color" size="10">
        </div>
        <div>
            <label for="text-lines-bg-color">Background text color:</label>
            <input type="color" value="" id="text-lines-bg-color" size="10">
        </div>
        <div>
            <label for="text-stroke-color">Stroke color:</label>
            <input type="color" value="" id="text-stroke-color">
        </div>
        <div>


            <label for="text-stroke-width">Stroke width:</label>
            <input type="range" value="0.1" min="0.1" max="5" step="0.1" id="text-stroke-width">
        </div>
        <div>
            <label for="outline-color">outline color:</label>
            <input type="color" value="#ff0000" id="outline-color">
        </div>
        <div>


            <label for="outline-width">Outline width:</label>
            <input type="range" value="0.1" min="0.1" max="100" step="0.1" id="outline-width">
        </div>
        <div>


            <label for="outline-blur">outline blur:</label>
            <input type="range" value="0" min="0" max="50" step="1" id="outline-blur">
        </div>
        <div>
            <label for="text-font-size">Font size:</label>
            <input type="range" value="" min="1" max="120" step="1" id="text-font-size">
        </div>
        <div>
            <label for="text-line-height">Line height:</label>
            <input type="range" value="" min="0" max="10" step="0.1" id="text-line-height">
        </div>
        <div>
            <label for="char-spacing">Char Spacing:</label>
            <input type="range" value="0" min="-500" max="500" step="1" id="char-spacing">
        </div>
    </div>
    <div id="text-controls-additional">
        <input type='checkbox' name='fonttype' id="text-cmd-bold">
        Bold

        <input type='checkbox' name='fonttype' id="text-cmd-italic">
        Italic

        <input type='checkbox' name='fonttype' id="text-cmd-underline">
        Underline

        <input type='checkbox' name='fonttype' id="text-cmd-linethrough">
        Linethrough

        <input type='checkbox' name='fonttype' id="text-cmd-overline">
        Overline

    </div>

    <textarea name="" id="shairText" cols="30" rows="10" dir="rtl"
        style="direction: rtl !important">فدا12الر78حما.9ن 9. (فدا) Khattak فد.8 فدا (FIDA) خان (FIDA فدا) الرحمان</textarea>
    <br>
    <button id="word-color">Word Color</button>
    <button id="shairTextBtn">Change Text</button>

    <button id="bti">brush to image</button>
    <script>






        // $(function () {
        function createCanvas() {

            

            fabric.Object.prototype.transparentCorners = false;
            fabric.Object.prototype.padding = 5;


            var $ = function (id) { return document.getElementById(id) };


            const canvas = window.canvas = new fabric.Canvas('c');
            canvas.setHeight(window.innerHeight - 100);
            canvas.setWidth(800);


            // canvas.set('isDrawingMode',true);
            //     canvas.freeDrawingBrush = new fabric.InkBrush(this.canvas, {
            //     width: 200,
            //     opacity: 1,
            //     color: "#ff0000",
            //     originX:'left',
            //     originY:'top'
            //     });


            var line = new fabric.Line([canvas.width / 2, 0, canvas.width / 2, canvas.height], {
                strokeWidth: 1,
                stroke: 'red',
            });












            const shair = 'فداالرحمان (فدا) Khattak فدا\nفدا (FIDA) خان (FIDA فدا) الرحمان فداالرحمان۔';
            // const shair = 'fida ur rehman khattak kay khelaf\nhum sab ne kaha hai keh';
            const text = new fabric.Textbox(shair);
            text.set({
                fontFamily: 'a-jameel-noori-nastaleeq',
                textAlign: 'right',
                isRTL: true,
                originX: 'right',
                fontSize: 40,
                isEditable: false,
                charSpacing: 0,
                top: 30,
                left: 600 + text.width,
                width: 300
            });
            // canvas.add(text);
            // line.left = text.left;

            // canvas.centerObject(text);
            // canvas.setActiveObject(text);
            // canvas.getActiveObject().setCoords();

            var canvas2 = document.getElementById("htmlCanvas");
            var ctx2 = canvas2.getContext("2d");
            ctx2.font = "50px a-jameel-noori-nastaleeq";
            ctx2.fillText(shair, 10, 50);

            
            console.log(fabric.Image.filters);
            var im;
            fabric.Image.fromURL('/man.png', function (oImg) {
                oImg.crossOrigin = "anonymous";

                // add filter
                // oImg.filters.push(new fabric.Image.filters.Outline({
                //     color: 'rgba(255, 255, 0, 1)', width: 30, blur: 5, inset: false
                // }));
                // oImg.filters.push(new fabric.Image.filters.Feather({
                // width: 50, blur: 10
                // }));
                // oImg.filters.push(new fabric.Image.filters.Feather({
                // from: 1, to: 20,
                // t: 'edges',
                // edges: {
                //     top: true,
                //     right: true,
                //     left: true,
                //     bottom: true
                // },
                // invert: false,
                // circle: {
                //     x: 50,
                //     y: 50,
                //     r: 50
                // }

                // }));
                oImg.filters.push(new fabric.Image.filters.InnerShadow({
                width: 10, blur:10,
                color: 'red',
                x: 10,
                y: 10
        

                }));





                // oImg.stroke = "#01FF00";
                // oImg.strokeWidth = 3;
                oImg.scaleToHeight(400);
                canvas.add(oImg);
                oImg.center();
                oImg.setCoords();
                oImg.applyFilters();
                canvas.backgroundColor="red";
                canvas.setActiveObject(oImg);
// canvas.renderTop();
                canvas.renderAll();
            });

            // fabric.Image.fromURL('/love.jpg', function (a) {
            //     a.crossOrigin = "anonymous";

            //     // add filter

            //     a.stroke = "#01FF00";
            //     a.strokeWidth = 3;

            //     canvas.add(a);
            //     a.setCoords();
            //     a.applyFilters();
            //     canvas.renderAll();
            // });



            //                im.filters.push(new fabric.Image.filters.Grayscale({
            //         color: 'rgba(255, 0, 0, 0.2)',width: 3, blur: 0, noise:19
            //     }));

            // // apply filters and re-render canvas when done
            // im.applyFilters(canvas.renderAll.bind(canvas));
            canvas.add(line);


            canvas.renderAll();





        }

        var mehrannastaleeq = new FontFace('a-jameel-noori-nastaleeq', 'url(/a-jameel-noori-nastaleeq.ttf)');
        mehrannastaleeq.load().then(function (loaded_face) {
            document.fonts.add(loaded_face);
            document.body.style.fontFamily = 'a-jameel-noori-nastaleeq", Arial';
            createCanvas();


            //HTML canvas



        }).catch(function (error) {
            // error occurred
        });
        document.fonts.ready.then(function (font_face_set) {
            // all fonts have been loaded
            // console.log('all fonts loaded');
        });
        document.getElementById('bti').onclick = function () {
            var pixelRatio = canvas.getRetinaScaling(),
            c = fabric.util.copyCanvasElement(canvas.upperCanvasEl),
            xy = fabric.util.trimCanvas(c),
            img = new fabric.Image(c);
        if (!xy) return;
        canvas.add(img);
        img.originX = 'left';
        img.originY = 'top';
        img.set({ left: xy.x / pixelRatio, top: xy.y / pixelRatio, 'scaleX': 1 / pixelRatio, 'scaleY': 1 / pixelRatio }).setCoords();
        canvas.clearContext(canvas.contextTop);
            canvas.renderAll();
        };
        // // function Addtext() {
        //     canvas.add(new fabric.Textbox('Tap and Type', {
        //         fontFamily: 'mn',
        //         textAlign: 'right',
        //         isRTL: true,
        //         originX: 'right',
        //         fontSize: 22,
        //         editable: false
        //     }));
        // // }
        // $(function () {
        document.getElementById('word-color').onclick = function () {
            canvas.getActiveObject().styles = {};
            canvas.renderAll();
            // canvas.getActiveObject().setSelectionStyles({ fontSize: 40 }, 0, 1);
            // canvas.getActiveObject().setSelectionStyles({ fontSize: 20 }, 2, 3);
            // canvas.getActiveObject().setSelectionStyles({ fontSize: 60 }, 4, 5);
            canvas.getActiveObject().setSelectionStyles({ underline: true }, 0, 1);
            // canvas.getActiveObject().setSelectionStyles({ fill: 'blue' }, 8, 9);
            canvas.renderAll();
        };
        document.getElementById('shairTextBtn').onclick = function () {

            let shair2 = document.getElementById('shairText').value.replace(/<br.*?>\n/g, '\n');
            shair2 = shair2.replace(/\n<br.*?>/g, '\n');
            shair2 = shair2.replace(/<br.*?>/g, '\n');
            shair2 = shair2.replace(/<\/?[^>]+(>|$)/g, '');
            shair2 = shair2.trim();

            if (shair2.length > 0) {

                let shair = '';


                const arabic = /[\u0600-\u06FF]/;
                const english = /[a-zA-Z0-9\~\`\!\@\#\$\%\^\&\*\(\)\_\-\+\=\}\{\[\]\;\:\"\'\?\/\,\.\<\>\☆\▪︎\¤\《\》\¡\¿\♧\◇\♡\♤\■\□\●\○\•\°]/;

                // if (arabic.test(shair2) && english.test(shair2)) {
                //     for (var i = 0; i < shair2.length; i++) {
                //         //   if (i === 0) {
                //         //     // // console.log('first+++++++++++++++++++');
                //         //     // // console.log(shair2.charAt(i));
                //         //     shair = '\u202A'
                //         //   }
                //         // if (english.test(shair2.charAt(i))) {
                //         //     if (shair2.charAt(i - 1)) {
                //         //         if (!english.test(shair2.charAt(i - 1))) {
                //         //             shair = shair + '\u202B' + shair2.charAt(i);
                //         //         } else {
                //         //             shair = shair + shair2.charAt(i);
                //         //         }
                //         //     } else {
                //         //         shair = shair + '\u202B' + shair2.charAt(i);
                //         //     }

                //         //     if (shair2.charAt(i + 1)) {
                //         //         if (!english.test(shair2.charAt(i + 1))) {
                //         //             shair = shair + '\u202C';
                //         //         }
                //         //     } else {
                //         //         shair = shair + '\u202C';
                //         //     }
                //         // } else {
                //         //     shair = shair + shair2.charAt(i);
                //         // }
                //         // if (i === shair2.length - 1) {
                //             // // console.log('last+++++++++++++++');
                //             // // console.log(shair2.charAt(i));
                //             // shair = shair + '\u202C'; 
                //             window.canvas.getActiveObject().setText(shair);
                //         // }

                //     }
                // } else {
                window.canvas.getActiveObject().setText(shair2);
                // shair = shair2;
                // }
            }
            // window.canvas.getActiveObject().setText( document.getElementById('shairText').value);
            window.canvas.renderAll();
        };
        document.getElementById('text-color').onchange = function () {
            canvas.getActiveObject().setFill(this.value);
            canvas.renderAll();
        };
        document.getElementById('text-color').onchange = function () {
            canvas.getActiveObject().setFill(this.value);
            canvas.renderAll();
        };

        document.getElementById('text-bg-color').onchange = function () {
            canvas.getActiveObject().setBackgroundColor(this.value);
            canvas.renderAll();
        };

        document.getElementById('text-lines-bg-color').onchange = function () {
            canvas.getActiveObject().setTextBackgroundColor(this.value);
            canvas.renderAll();
        };

        document.getElementById('text-stroke-color').onchange = function () {
            canvas.getActiveObject().setStroke(this.value);
            canvas.renderAll();
        };

        document.getElementById('text-stroke-width').onchange = function () {
            canvas.getActiveObject().setStrokeWidth(parseFloat(this.value));
            canvas.renderAll();
        };
        document.getElementById('outline-color').onchange = function () {
            canvas.getActiveObject().filters[0].color = this.value;
            canvas.getActiveObject().applyFilters();
            canvas.renderAll();
        };

        document.getElementById('outline-width').onchange = function () {
            canvas.getActiveObject().filters[0].width = this.value;
            canvas.getActiveObject().applyFilters();
            canvas.renderAll();
        };
        document.getElementById('outline-blur').onchange = function () {
            canvas.getActiveObject().filters[0].blur = this.value;
            canvas.getActiveObject().applyFilters();
            canvas.renderAll();
        };
        document.getElementById('font-family').onchange = function () {
            canvas.getActiveObject().setFontFamily(this.value);
            canvas.renderAll();
        };

        document.getElementById('text-font-size').onchange = function () {
            canvas.getActiveObject().setFontSize(this.value);
            // canvas.getActiveObject().setSelectionStyles({ fontSize: this.value }, 2, 3);
            canvas.renderAll();
        };
        document.getElementById('char-spacing').onchange = function () {
            canvas.getActiveObject().set('charSpacing', parseInt(this.value));
            canvas.renderAll();
        };
        document.getElementById('text-line-height').onchange = function () {
            canvas.getActiveObject().setLineHeight(this.value);
            canvas.renderAll();
        };

        document.getElementById('text-align').onchange = function () {
            window.canvas.getActiveObject().setTextAlign(this.value);
            window.canvas.renderAll();
        };


        radios5 = document.getElementsByName('fonttype');  // wijzig naar button
        for (var i = 0, max = radios5.length; i < max; i++) {
            radios5[i].onclick = function () {

                if (document.getElementById(this.id).checked === true) {
                    if (this.id === 'text-cmd-bold') {
                        canvas.getActiveObject().set('fontWeight', 'bold');
                    }
                    if (this.id === 'text-cmd-italic') {
                        canvas.getActiveObject().set('fontStyle', 'italic');
                    }
                    if (this.id === 'text-cmd-underline') {
                        canvas.getActiveObject().set('textDecoration', 'underline');
                    }
                    if (this.id === 'text-cmd-linethrough') {
                        canvas.getActiveObject().set('textDecoration', 'line-through');
                    }
                    if (this.id === 'text-cmd-overline') {
                        canvas.getActiveObject().set('textDecoration', 'overline');
                    }



                } else {
                    if (this.id === 'text-cmd-bold') {
                        canvas.getActiveObject().set('fontWeight', '');
                    }
                    if (this.id === 'text-cmd-italic') {
                        canvas.getActiveObject().set('fontStyle', '');
                    }
                    if (this.id === 'text-cmd-underline') {
                        canvas.getActiveObject().set('textDecoration', '');
                    }
                    if (this.id === 'text-cmd-linethrough') {
                        canvas.getActiveObject().set('textDecoration', '');
                    }
                    if (this.id === 'text-cmd-overline') {
                        canvas.getActiveObject().set('textDecoration', '');
                    }
                }


                canvas.renderAll();
            }
        }
        // console.log('ready!');
        // });
    </script>